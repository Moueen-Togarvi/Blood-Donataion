{% extends 'main.html' %}
{% block content %}
<main class="container">
  <div class="layout-grid">
    <!-- Main Content: Case File -->
    <div class="case-file">
      <div class="card">
        <div class="card__header">
          <a href="{% url 'home' %}" class="btn btn--text">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"
              style="margin-right: 5px;">
              <path fill-rule="evenodd"
                d="M15 8a.5.5 0 0 0-.5-.5H2.707l3.147-3.146a.5.5 0 1 0-.708-.708l-4 4a.5.5 0 0 0 0 .708l4 4a.5.5 0 0 0 .708-.708L2.707 8.5H14.5A.5.5 0 0 0 15 8z" />
            </svg>
            Back to requests
          </a>

          {% if room.host == request.user %}
          <div class="actions">
            <a href="{% url 'update-room' room.id %}" class="btn btn--secondary">Edit</a>
            <a href="{% url 'delete-room' room.id %}" class="btn btn--secondary"
              style="color: var(--color-error); border-color: var(--color-error);">Delete</a>
          </div>
          {% endif %}
        </div>

        <div class="case-header" style="display: flex; align-items: center; gap: 2rem; margin-bottom: 3rem;">
          <div class="blood-drop" style="width: 8rem; height: 8rem; font-size: 3rem;">
            {{room.topic.name}}
          </div>
          <div>
            <h1 style="font-size: 2.4rem; font-weight: 700; margin-bottom: 0.5rem;">{{room.name}}</h1>
            <p style="color: var(--color-text-muted);">
              Posted by <a href="{% url 'user-profile' room.host.id %}"
                style="color: var(--color-primary); font-weight: 500;">{{room.host.name|default:room.host.username}}</a>
              â€¢ {{room.created|timesince}} ago
            </p>
          </div>
        </div>

        <div class="case-details" style="margin-bottom: 3rem;">
          <h3 class="form-label" style="font-size: 1.6rem; color: var(--color-text-main);">Case Details</h3>
          <p style="white-space: pre-wrap; color: var(--color-text-muted); line-height: 1.6;">{{room.description}}</p>
        </div>

        <div class="case-comments">
          <h3 class="form-label">Discussion / Updates</h3>
          <div class="comments-list" style="margin-bottom: 2rem;">
            {% for message in room_messages %}
            <div class="comment" style="display: flex; gap: 1.5rem; margin-bottom: 1.5rem;">
              <img src="{{message.user.avatar.url}}" class="avatar avatar--sm">
              <div>
                <div class="comment-meta" style="font-size: 1.3rem; margin-bottom: 0.2rem;">
                  <span style="font-weight: 600;">{{message.user.name|default:message.user.username}}</span>
                  <span style="color: var(--color-text-muted);">{{message.created|timesince}} ago</span>
                  {% if request.user == message.user %}
                  <a href="{% url 'delete-message' message.id %}"
                    style="color: var(--color-error); margin-left: 0.5rem;">Delete</a>
                  {% endif %}
                </div>
                <p>{{message.body}}</p>
              </div>
            </div>
            {% endfor %}
          </div>

          {% if request.user.is_authenticated %}
          <form action="" method="POST">
            {% csrf_token %}
            <input name="body" class="form-input" placeholder="Ask a question or offer help..." required />
          </form>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Sidebar: Donors -->
    <aside>
      <div class="card">
        <h3 class="form-label">Interactions</h3>
        <p style="color: var(--color-text-muted); margin-bottom: 1.5rem;">{{participants.count}} people offered help or
          commented.</p>

        <div class="donor-list">
          {% for user in participants %}
          <a href="{% url 'user-profile' user.id %}"
            style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
            <img src="{{user.avatar.url}}" class="avatar avatar--sm">
            <span>{{user.name|default:user.username}}</span>
          </a>
          {% endfor %}
        </div>
      </div>
    </aside>
  </div>
</main>
{% endblock %}